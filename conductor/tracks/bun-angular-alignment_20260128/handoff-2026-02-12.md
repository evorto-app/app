# Session Handoff â€” 2026-02-12

## Scope Completed

Completed additional Effect RPC migration slices:

1. Migrated `users.events.findMany` from tRPC and cut the profile events query over to `AppRpc`.
2. Migrated account bootstrap procedures `users.authData` and `users.createAccount` from tRPC and cut `create-account` over to `AppRpc`.
3. Removed the remaining Angular `injectTRPCClient()` callsites by switching to typed query-options/fetch-query patterns.
4. Migrated `users.findMany` from tRPC and cut the admin user listing query over to `AppRpc`.
5. Migrated `admin.roles.findMany/findOne/search` read paths from tRPC and cut all Angular role read callsites over to `AppRpc`.
6. Migrated `admin.roles.findHubRoles` from tRPC and cut the members-hub role query over to `AppRpc`.

## Code Changes

- Added Effect RPC contract for user events:
  - `src/shared/rpc-contracts/app-rpcs.ts`
  - introduced `UsersEventSummaryRecord` + `UsersEventsFindMany`
  - registered the procedure in `AppRpcs` with tag `users.events`
- Added Effect RPC handler for the user events read:
  - `src/server/effect/rpc/app-rpcs.handlers.ts`
  - new `users.events` handler using authenticated headers + tenant/user context
- Migrated profile callsite:
  - `src/app/profile/user-profile/user-profile.component.ts`
  - replaced `injectTRPC().users.events.findMany.queryOptions()` with `AppRpc.injectClient().users.events.queryOptions()`
- Removed legacy tRPC procedure:
  - `src/server/trpc/users/users.router.ts`
  - deleted `events.findMany` namespace/procedure
- Added Effect RPC contracts for account bootstrap:
  - `src/shared/rpc-contracts/app-rpcs.ts`
  - introduced `UsersAuthDataFind` + `UsersCreateAccount`
  - added typed payload/error schemas for `users.createAccount`
- Added Effect RPC handlers for account bootstrap:
  - `src/server/effect/rpc/app-rpcs.handlers.ts`
  - new `users.authData` + `users.createAccount` handlers with tenant/user-role creation logic
- Bridged OIDC auth data into RPC headers:
  - `src/server/effect/rpc/app-rpcs.web-handler.ts`
  - added `x-evorto-auth-data` header mapping from `request.oidc?.user`
- Migrated create-account callsites:
  - `src/app/core/create-account/create-account.component.ts`
  - replaced tRPC auth-data query/mutation with `AppRpc.injectClient().users.authData/queryOptions()` and `users.createAccount.mutationOptions()`
- Removed legacy tRPC procedures:
  - `src/server/trpc/users/users.router.ts`
  - deleted `authData` and `createAccount`
- Removed remaining `injectTRPCClient()` usage in Angular:
  - `src/app/events/guards/event-edit.guard.ts`
  - `src/app/events/guards/event-organizer.guard.ts`
  - `src/app/shared/components/controls/role-select/role-select.component.ts`
  - guards now use `QueryClient.fetchQuery(trpc.<path>.queryOptions(...))`
  - role-select now resolves current roles via `this.trpc.admin.roles.findOne.queryOptions(...)`
- Added Effect RPC contract/handler for admin user list:
  - `src/shared/rpc-contracts/app-rpcs.ts`: added `users.findMany` input/result schemas and procedure
  - `src/server/effect/rpc/app-rpcs.handlers.ts`: added `users.findMany` handler with permission check + tenant-scoped joins
- Migrated admin user list callsite:
  - `src/app/admin/user-list/user-list.component.ts`
  - switched to `AppRpc.injectClient().users.findMany.queryOptions(...)`
- Removed legacy tRPC procedure:
  - `src/server/trpc/users/users.router.ts`
  - deleted `findMany`
- Added Effect RPC contracts/handlers for role read paths:
  - `src/shared/rpc-contracts/app-rpcs.ts`: added `admin.roles.findMany`, `admin.roles.findOne`, and `admin.roles.search` contracts
  - `src/server/effect/rpc/app-rpcs.handlers.ts`: added handlers for all three role read procedures
  - note: these methods are exposed on the current helper surface as bracket-key members (`rpc.admin['roles.findMany']`, etc.)
- Migrated Angular role read callsites:
  - `src/app/admin/role-list/role-list.component.ts`
  - `src/app/admin/role-details/role-details.component.ts`
  - `src/app/admin/role-edit/role-edit.component.ts`
  - `src/app/shared/components/controls/role-select/role-select.component.ts`
  - `src/app/templates/template-create/template-create.component.ts`
- Updated role create/edit invalidation paths to invalidate `AppRpc` role query filters.
- Removed legacy tRPC role read procedures:
  - `src/server/trpc/admin/role.router.ts`
  - deleted `findMany`, `findOne`, and `search`
- Added Effect RPC contract/handler for members-hub roles:
  - `src/shared/rpc-contracts/app-rpcs.ts`: added `admin.roles.findHubRoles` result schema and procedure
  - `src/server/effect/rpc/app-rpcs.handlers.ts`: added `admin.roles.findHubRoles` handler with safe nullable user mapping
- Migrated members-hub callsite:
  - `src/app/internal-pages/members-hub/members-hub.component.ts`
  - switched role query from `injectTRPC().admin.roles.findHubRoles.queryOptions()` to `AppRpc.injectClient().admin['roles.findHubRoles'].queryOptions()`
- Updated role mutation invalidation coverage:
  - `src/app/admin/role-create/role-create.component.ts`
  - `src/app/admin/role-edit/role-edit.component.ts`
  - now also invalidates the `admin.roles.findHubRoles` Effect RPC query filter
- Removed legacy tRPC procedure:
  - `src/server/trpc/admin/role.router.ts`
  - deleted `findHubRoles`

## Validation Executed

- `bunx --bun eslint src/shared/rpc-contracts/app-rpcs.ts src/server/effect/rpc/app-rpcs.handlers.ts src/app/profile/user-profile/user-profile.component.ts src/server/trpc/users/users.router.ts`
  - result: passed (warnings-only baseline)
- `bunx --bun tsc -p tsconfig.app.json --noEmit`
  - result: passed
- `bunx --bun tsc -p tsconfig.spec.json --noEmit`
  - result: passed
- `CI=true bun run lint`
  - result: passed (warnings-only baseline)
- `CI=true bun run build`
  - result: passed
- `CI=true bun run test`
  - result: `12 passed`
- `bash -lc 'eval "$(bun helpers/testing/runtime-env.mjs)" && CI=true NO_WEBSERVER=true bunx --bun playwright test tests/docs/profile/discounts.doc.ts --project=docs --workers=1 --max-failures=1'`
  - result: `8 passed`
- `bunx --bun eslint src/shared/rpc-contracts/app-rpcs.ts src/server/effect/rpc/app-rpcs.web-handler.ts src/server/effect/rpc/app-rpcs.handlers.ts src/app/core/create-account/create-account.component.ts src/server/trpc/users/users.router.ts`
  - result: passed (warnings-only baseline)
- `bunx --bun tsc -p tsconfig.app.json --noEmit`
  - result: passed after account bootstrap cutover
- `bunx --bun tsc -p tsconfig.spec.json --noEmit`
  - result: passed after account bootstrap cutover
- `CI=true bun run lint`
  - result: passed (warnings-only baseline) after account bootstrap cutover
- `CI=true bun run build`
  - result: passed after account bootstrap cutover
- `CI=true bun run test`
  - result: `12 passed` after account bootstrap cutover
- `bunx --bun eslint src/app/events/guards/event-edit.guard.ts src/app/events/guards/event-organizer.guard.ts src/app/shared/components/controls/role-select/role-select.component.ts`
  - result: passed
- `bunx --bun tsc -p tsconfig.app.json --noEmit`
  - result: passed after injector-callsite cleanup
- `bunx --bun tsc -p tsconfig.spec.json --noEmit`
  - result: passed after injector-callsite cleanup
- `rg -n "injectTRPCClient\\(" src/app`
  - result: no matches
- `CI=true bun run lint`
  - result: passed (warnings-only baseline) after injector-callsite cleanup
- `CI=true bun run build`
  - result: passed after injector-callsite cleanup
- `CI=true bun run test`
  - result: `12 passed` after injector-callsite cleanup
- `bunx --bun eslint src/shared/rpc-contracts/app-rpcs.ts src/server/effect/rpc/app-rpcs.handlers.ts src/app/admin/user-list/user-list.component.ts src/server/trpc/users/users.router.ts`
  - result: passed after `users.findMany` cutover
- `bunx --bun tsc -p tsconfig.app.json --noEmit`
  - result: passed after `users.findMany` cutover
- `bunx --bun tsc -p tsconfig.spec.json --noEmit`
  - result: passed after `users.findMany` cutover
- `CI=true bun run lint`
  - result: passed (warnings-only baseline) after `users.findMany` cutover
- `CI=true bun run build`
  - result: passed after `users.findMany` cutover
- `CI=true bun run test`
  - result: `12 passed` after `users.findMany` cutover
- `bunx --bun eslint src/shared/rpc-contracts/app-rpcs.ts src/server/effect/rpc/app-rpcs.handlers.ts src/server/trpc/admin/role.router.ts src/app/admin/role-list/role-list.component.ts src/app/templates/template-create/template-create.component.ts src/app/admin/role-details/role-details.component.ts src/app/admin/role-edit/role-edit.component.ts src/app/admin/role-create/role-create.component.ts src/app/shared/components/controls/role-select/role-select.component.ts`
  - result: passed after `admin.roles` read cutover
- `bunx --bun tsc -p tsconfig.app.json --noEmit`
  - result: passed after `admin.roles` read cutover
- `bunx --bun tsc -p tsconfig.spec.json --noEmit`
  - result: passed after `admin.roles` read cutover
- `CI=true bun run lint`
  - result: passed (warnings-only baseline) after `admin.roles` read cutover
- `CI=true bun run build`
  - result: passed after `admin.roles` read cutover
- `CI=true bun run test`
  - result: `12 passed` after `admin.roles` read cutover
- `bash -lc 'eval "$(bun helpers/testing/runtime-env.mjs)" && CI=true NO_WEBSERVER=true bunx --bun playwright test tests/docs/roles/roles.doc.ts --project=docs --workers=1 --max-failures=1'`
  - result: `8 passed` after `admin.roles` read cutover
- `bunx --bun eslint src/shared/rpc-contracts/app-rpcs.ts src/server/effect/rpc/app-rpcs.handlers.ts src/server/trpc/admin/role.router.ts src/app/internal-pages/members-hub/members-hub.component.ts src/app/internal-pages/members-hub/members-hub.component.html src/app/admin/role-create/role-create.component.ts src/app/admin/role-edit/role-edit.component.ts`
  - result: passed after `admin.roles.findHubRoles` cutover
- `bunx --bun tsc -p tsconfig.app.json --noEmit`
  - result: passed after `admin.roles.findHubRoles` cutover
- `bunx --bun tsc -p tsconfig.spec.json --noEmit`
  - result: passed after `admin.roles.findHubRoles` cutover
- `CI=true bun run lint`
  - result: passed (warnings-only baseline) after `admin.roles.findHubRoles` cutover
- `CI=true bun run build`
  - result: passed after `admin.roles.findHubRoles` cutover
- `CI=true bun run test`
  - result: `12 passed` after `admin.roles.findHubRoles` cutover
- `bash -lc 'eval "$(bun helpers/testing/runtime-env.mjs)" && CI=true NO_WEBSERVER=true bunx --bun playwright test tests/docs/roles/roles.doc.ts --project=docs --workers=1 --max-failures=1'`
  - result: `8 passed` after `admin.roles.findHubRoles` cutover

## Commits

- `f24cb75` `feat(effect-rpc): migrate users.events query from trpc`
- `ec4fdd5` `feat(effect-rpc): migrate account bootstrap users procedures`
- `5f9ba3c` `refactor(trpc): remove injectTRPCClient callsites`
- `0998a26` `feat(effect-rpc): migrate users.findMany admin listing`
- `dd9d982` `feat(effect-rpc): migrate admin role read procedures`
- `272aa1a` `conductor(docs): record admin roles read rpc cutover`
- `2eb1a6e` `feat(effect-rpc): migrate admin role hub query`

## Remaining Opportunities / Next Steps

1. Continue decommissioning remaining `admin.roles` mutation tRPC surfaces (`create`, `update`, `delete`) into Effect RPC slices.
2. Re-run a full final-gate pass (`lint:fix`, `lint`, `build`, `test`, `e2e`, `e2e:docs`) after the next migration batch.
