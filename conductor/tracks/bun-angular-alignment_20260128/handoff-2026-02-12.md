# Session Handoff â€” 2026-02-12

## Scope Completed

Completed two additional Effect RPC migration slices:

1. Migrated `users.events.findMany` from tRPC and cut the profile events query over to `AppRpc`.
2. Migrated account bootstrap procedures `users.authData` and `users.createAccount` from tRPC and cut `create-account` over to `AppRpc`.

## Code Changes

- Added Effect RPC contract for user events:
  - `src/shared/rpc-contracts/app-rpcs.ts`
  - introduced `UsersEventSummaryRecord` + `UsersEventsFindMany`
  - registered the procedure in `AppRpcs` with tag `users.events`
- Added Effect RPC handler for the user events read:
  - `src/server/effect/rpc/app-rpcs.handlers.ts`
  - new `users.events` handler using authenticated headers + tenant/user context
- Migrated profile callsite:
  - `src/app/profile/user-profile/user-profile.component.ts`
  - replaced `injectTRPC().users.events.findMany.queryOptions()` with `AppRpc.injectClient().users.events.queryOptions()`
- Removed legacy tRPC procedure:
  - `src/server/trpc/users/users.router.ts`
  - deleted `events.findMany` namespace/procedure
- Added Effect RPC contracts for account bootstrap:
  - `src/shared/rpc-contracts/app-rpcs.ts`
  - introduced `UsersAuthDataFind` + `UsersCreateAccount`
  - added typed payload/error schemas for `users.createAccount`
- Added Effect RPC handlers for account bootstrap:
  - `src/server/effect/rpc/app-rpcs.handlers.ts`
  - new `users.authData` + `users.createAccount` handlers with tenant/user-role creation logic
- Bridged OIDC auth data into RPC headers:
  - `src/server/effect/rpc/app-rpcs.web-handler.ts`
  - added `x-evorto-auth-data` header mapping from `request.oidc?.user`
- Migrated create-account callsites:
  - `src/app/core/create-account/create-account.component.ts`
  - replaced tRPC auth-data query/mutation with `AppRpc.injectClient().users.authData/queryOptions()` and `users.createAccount.mutationOptions()`
- Removed legacy tRPC procedures:
  - `src/server/trpc/users/users.router.ts`
  - deleted `authData` and `createAccount`

## Validation Executed

- `bunx --bun eslint src/shared/rpc-contracts/app-rpcs.ts src/server/effect/rpc/app-rpcs.handlers.ts src/app/profile/user-profile/user-profile.component.ts src/server/trpc/users/users.router.ts`
  - result: passed (warnings-only baseline)
- `bunx --bun tsc -p tsconfig.app.json --noEmit`
  - result: passed
- `bunx --bun tsc -p tsconfig.spec.json --noEmit`
  - result: passed
- `CI=true bun run lint`
  - result: passed (warnings-only baseline)
- `CI=true bun run build`
  - result: passed
- `CI=true bun run test`
  - result: `12 passed`
- `bash -lc 'eval "$(bun helpers/testing/runtime-env.mjs)" && CI=true NO_WEBSERVER=true bunx --bun playwright test tests/docs/profile/discounts.doc.ts --project=docs --workers=1 --max-failures=1'`
  - result: `8 passed`
- `bunx --bun eslint src/shared/rpc-contracts/app-rpcs.ts src/server/effect/rpc/app-rpcs.web-handler.ts src/server/effect/rpc/app-rpcs.handlers.ts src/app/core/create-account/create-account.component.ts src/server/trpc/users/users.router.ts`
  - result: passed (warnings-only baseline)
- `bunx --bun tsc -p tsconfig.app.json --noEmit`
  - result: passed after account bootstrap cutover
- `bunx --bun tsc -p tsconfig.spec.json --noEmit`
  - result: passed after account bootstrap cutover
- `CI=true bun run lint`
  - result: passed (warnings-only baseline) after account bootstrap cutover
- `CI=true bun run build`
  - result: passed after account bootstrap cutover
- `CI=true bun run test`
  - result: `12 passed` after account bootstrap cutover

## Commits

- `f24cb75` `feat(effect-rpc): migrate users.events query from trpc`
- `ec4fdd5` `feat(effect-rpc): migrate account bootstrap users procedures`

## Remaining Opportunities / Next Steps

1. Continue decommissioning remaining `users` and adjacent profile/event tRPC surfaces into Effect RPC slices.
2. Re-run a full final-gate pass (`lint:fix`, `lint`, `build`, `test`, `e2e`, `e2e:docs`) after the next migration batch.
