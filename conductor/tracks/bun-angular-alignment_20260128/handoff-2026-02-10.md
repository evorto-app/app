# Session Handoff (2026-02-10)

## Scope Closed In This Session

- Completed two Effect RPC vertical slices:
  - `templateCategories`
  - `templates.groupedByCategory` (read path)
- Kept mixed-protocol behavior intentionally scoped:
  - `templateCategories` + grouped template list reads now run on Effect RPC.
  - high-complexity template write/read details remain on tRPC for the next slices.
- Committed milestones:
  - `b4ea817` `feat(effect-rpc): migrate template categories domain off trpc`
  - `4c901a3` `feat(effect-rpc): migrate templates groupedByCategory reads`

## What Was Implemented

1. Shared RPC contracts
   - `src/shared/rpc-contracts/app-rpcs.ts`
   - Added:
     - `templateCategories.findMany`
     - `templateCategories.create`
     - `templateCategories.update`
   - Added typed schemas for record and error channels.

2. Server handlers

- `src/server/effect/rpc/app-rpcs.handlers.ts`
- Added authenticated/permissioned handlers for template categories.
- Enforced `templates:manageCategories` for create/update.
- Added tenant-scoped DB reads/writes for category CRUD paths.
- Added tenant-scoped grouped template read handler for `templates.groupedByCategory`.

3. Angular callsites
   - `src/app/templates/shared/template-form/template-general-form.component.ts`
   - `src/app/templates/shared/template-form/template-general-form.component.html`
   - Migrated `templateCategories.findMany` query to Effect RPC query helpers.
   - Added typed computed fallback array for strict-template iteration.
   - `src/app/templates/categories/category-list/category-list.component.ts`
   - Migrated create/update mutations to `EffectRpcClient`.

- Invalidation now targets Effect RPC `templateCategories.findMany` query key.
- `src/app/templates/template-list/template-list.component.ts`
- `src/app/templates/template-list/template-list.component.html`
- Migrated grouped template-list query to Effect RPC helpers with typed error rendering.
- `src/app/templates/categories/category-list/category-list.component.ts`
- `src/app/templates/categories/category-list/category-list.component.html`
- Migrated grouped query source to Effect RPC helpers with typed error rendering.
- `src/app/templates/template-create/template-create.component.ts`
- `src/app/templates/template-edit/template-edit.component.ts`
- Updated grouped template-list invalidation keys to Effect RPC query filter.

4. tRPC decommission for this slice

- `src/server/trpc/app-router.ts`: removed `templateCategories` namespace.
- Deleted obsolete router:
  - `src/server/trpc/templates/template-category.router.ts`
- Removed `templates.groupedByCategory` from:
  - `src/server/trpc/templates/template.router.ts`

5. Release note

- Added `.changeset/effect-rpc-template-categories-slice.md`.
- Added `.changeset/effect-rpc-templates-grouped-by-category-slice.md`.

## Validation Snapshot

- `CI=true bun run lint:fix` ✅ (warnings-only baseline unchanged)
- `CI=true bun run lint` ✅ (warnings-only baseline unchanged)
- `CI=true bun run build` ✅
- `CI=true bun run test` ✅
- `bash -lc 'eval "$(bun helpers/testing/runtime-env.mjs)" && CI=true NO_WEBSERVER=true bunx --bun playwright test tests/specs/templates/templates.test.ts --project=local-chrome --workers=1 --max-failures=1'` ✅ (`11 passed`)
- `CI=true bun run e2e:docs` ✅ (`23 passed`)

## Current Repository State

- Working tree expected to include this docs sync commit plus user-local:
  - `.env.local` (left untouched and intentionally uncommitted)

## Next Slice Recommendation (Priority Order)

1. Migrate `templates.findOne` to Effect RPC
   - Server:
     - `src/server/trpc/templates/template.router.ts` (`findOne`)
     - `src/server/effect/rpc/app-rpcs.handlers.ts`
     - `src/shared/rpc-contracts/app-rpcs.ts`
   - Client callsites:
     - `src/app/templates/template-edit/template-edit.component.ts`
     - `src/app/templates/template-details/template-details.component.ts`
     - `src/app/templates/template-create-event/template-create-event.component.ts`
2. Then migrate `templates.createSimpleTemplate` + `templates.updateSimpleTemplate` in bounded steps.
3. Keep tax-rate validation behavior and strict rich-text sanitization checks unchanged during write-path migration.

## Resume Commands

```bash
git checkout bun-effect-migration
bun install --frozen-lockfile
CI=true bun run lint
CI=true bun run build
```
