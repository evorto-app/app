<div class="mb-4 flex items-center justify-between gap-2">
  <h1 class="title-large">Review receipt</h1>
  <a mat-button [routerLink]="['/finance/receipts-approval']">Back</a>
</div>

@if (receiptQuery.isPending()) {
  <div class="bg-surface text-on-surface rounded-2xl p-4">Loading receipt...</div>
} @else if (receiptQuery.isError()) {
  <div class="bg-error-container text-on-error-container rounded-2xl p-4">
    Failed to load receipt details.
  </div>
} @else {
  @let receipt = receiptQuery.data();
  @if (receipt) {
    <div class="grid gap-4 lg:grid-cols-2">
    <section class="bg-surface text-on-surface rounded-2xl p-4">
      <h2 class="title-medium mb-3">Receipt image</h2>
      @if (receipt.previewImageUrl) {
        <img
          [src]="receipt.previewImageUrl"
          alt="Receipt preview"
          class="max-h-[28rem] w-full rounded-xl object-contain"
        />
      } @else {
        <div
          class="bg-surface-container text-on-surface-variant flex min-h-64 items-center justify-center rounded-xl p-4"
        >
          No preview image available
        </div>
      }
      <p class="text-on-surface-variant mt-3 text-sm">
        {{ receipt.attachmentFileName }}
      </p>
    </section>

    <section class="bg-surface text-on-surface rounded-2xl p-4">
      <h2 class="title-medium mb-3">Receipt data</h2>
      <form class="grid grid-cols-1 gap-4 md:grid-cols-2">
        <mat-form-field>
          <mat-label>Receipt date</mat-label>
          <input matInput type="date" [formControl]="form.controls.receiptDate" />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Country</mat-label>
          <input matInput [formControl]="form.controls.purchaseCountry" />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Total amount (EUR)</mat-label>
          <input
            matInput
            min="0"
            step="0.01"
            type="number"
            [formControl]="form.controls.totalAmount"
          />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Tax rate</mat-label>
          <mat-select [formControl]="form.controls.stripeTaxRateId">
            @for (taxRate of taxRatesQuery.data(); track taxRate.stripeTaxRateId) {
              <mat-option [value]="taxRate.stripeTaxRateId">
                {{ taxRate.displayName || "Tax rate" }}
                @if (taxRate.percentage) {
                  ({{ taxRate.percentage }}%)
                }
              </mat-option>
            }
          </mat-select>
        </mat-form-field>

        <mat-form-field>
          <mat-label>Deposit amount (EUR)</mat-label>
          <input
            matInput
            min="0"
            step="0.01"
            type="number"
            [formControl]="form.controls.depositAmount"
          />
        </mat-form-field>

        <mat-form-field>
          <mat-label>Alcohol amount (EUR)</mat-label>
          <input
            matInput
            min="0"
            step="0.01"
            type="number"
            [formControl]="form.controls.alcoholAmount"
          />
        </mat-form-field>
      </form>

      <div class="mt-3 flex flex-wrap gap-4">
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" [formControl]="form.controls.hasDeposit" />
          <span>Deposit involved</span>
        </label>
        <label class="inline-flex items-center gap-2">
          <input type="checkbox" [formControl]="form.controls.hasAlcohol" />
          <span>Alcohol purchased</span>
        </label>
      </div>

      <mat-form-field class="mt-4 w-full">
        <mat-label>Rejection reason</mat-label>
        <textarea
          #reasonInput
          matInput
          rows="3"
          [value]="rejectionReason()"
          (input)="updateRejectionReason(reasonInput.value)"
        ></textarea>
      </mat-form-field>

      <div class="mt-4 flex flex-wrap justify-end gap-2">
        <button
          mat-stroked-button
          color="warn"
          (click)="reject()"
          [disabled]="reviewMutation.isPending()"
          type="button"
        >
          Reject
        </button>
        <button
          mat-raised-button
          color="primary"
          (click)="approve()"
          [disabled]="reviewMutation.isPending()"
          type="button"
        >
          Approve
        </button>
      </div>
    </section>
    </div>
  }
}
