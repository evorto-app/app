<form
  (submit)="onSubmit($event)"
  class="text-on-surface flex flex-col gap-6"
>
  <div class="bg-surface rounded-2xl p-4">
    <div class="grid grid-cols-1 gap-2 lg:grid-cols-[auto_1fr_1fr]">
      <app-icon-selector-field
        [formField]="templateForm.icon"
      ></app-icon-selector-field>
      <mat-form-field>
        <mat-label>Template title</mat-label>
        <input matInput [formField]="templateForm.title" />
      </mat-form-field>
      <mat-form-field>
        <mat-label>Template Category</mat-label>
        <mat-select [formField]="templateForm.categoryId">
          @for (
            templateCategory of templateCategoriesQuery.data();
            track templateCategory.id
          ) {
            <mat-option [value]="templateCategory.id">
              {{ templateCategory.title }}
            </mat-option>
          } @empty {
            <mat-option disabled>No template categories found</mat-option>
          }
        </mat-select>
      </mat-form-field>
    </div>
    <app-location-selector-field [formField]="templateForm.location" />

    <app-editor [formField]="templateForm.description"></app-editor>
  </div>

  <div class="bg-surface rounded-2xl p-4">
    <h2 class="mb-4 text-lg font-semibold">Simple Registration Setup</h2>
    <p class="mb-4 text-sm">
      This is the simple registration mode, which creates one registration
      option for organizers and one for participants.
    </p>

    <div class="grid grid-cols-1 gap-4 lg:grid-cols-2">
      <div>
        <h3 class="mb-3 font-medium">Organizer Registration</h3>
        <div class="grid gap-4 p-4">
          <mat-slide-toggle [formField]="templateForm.organizerRegistration.isPaid"
            >Enable Payment
          </mat-slide-toggle>

          @if (!templateForm.organizerRegistration.price().hidden()) {
            <mat-form-field>
              <mat-label>Price (in cents)</mat-label>
              <input
                matInput
                type="number"
                [formField]="templateForm.organizerRegistration.price"
              />
            </mat-form-field>

            <mat-form-field>
              <mat-label>Tax rate</mat-label>
              <mat-select
                [formField]="templateForm.organizerRegistration.stripeTaxRateId"
              >
                @if (taxRatesQuery.isPending()) {
                  <mat-option disabled>Loading tax rates ...</mat-option>
                } @else if (taxRatesQuery.isSuccess()) {
                  @for (rate of taxRatesQuery.data(); track rate.id) {
                    <mat-option [value]="rate.stripeTaxRateId">
                      {{ rate.displayName || rate.stripeTaxRateId }} —
                      {{ rate.percentage ?? "?" }}%
                    </mat-option>
                  }
                } @else {
                  <mat-option disabled>Failed to load tax rates</mat-option>
                }
              </mat-select>
              <mat-hint>Inclusive tax; shown price is final</mat-hint>
            </mat-form-field>
          }

          <mat-form-field>
            <mat-label>Number of Spots</mat-label>
            <input
              matInput
              type="number"
              [formField]="templateForm.organizerRegistration.spots"
            />
            <mat-hint>How many organizers can register</mat-hint>
          </mat-form-field>

          <app-role-select
            [formField]="templateForm.organizerRegistration.roleIds"
          ></app-role-select>

          <mat-form-field>
            <mat-label>Registration Mode</mat-label>
            <mat-select
              [formField]="templateForm.organizerRegistration.registrationMode"
            >
              @for (mode of registrationModes; track mode) {
                <mat-option [value]="mode">
                  {{ mode }}
                </mat-option>
              }
            </mat-select>
            <mat-hint>How registrations are processed</mat-hint>
          </mat-form-field>

          <div class="flex flex-col gap-2">
            <label class="text-on-surface-variant text-sm"
              >Registration Opens Before Event</label
            >
            <app-duration-selector
              [formField]="
                templateForm.organizerRegistration.openRegistrationOffset
              "
              hint="How long before the event should registration open"
            ></app-duration-selector>
          </div>

          <div class="flex flex-col gap-2">
            <label class="text-on-surface-variant text-sm"
              >Registration Closes Before Event</label
            >
            <app-duration-selector
              [formField]="
                templateForm.organizerRegistration.closeRegistrationOffset
              "
              hint="How long before the event should registration close"
            ></app-duration-selector>
          </div>
        </div>
      </div>

      <div>
        <h3 class="mb-3 font-medium">Participant Registration</h3>
        <div class="grid gap-4 p-4">
          <mat-slide-toggle
            [formField]="templateForm.participantRegistration.isPaid"
          >
            Enable Payment
          </mat-slide-toggle>

          @if (!templateForm.participantRegistration.price().hidden()) {
            <mat-form-field>
              <mat-label>Price (in cents)</mat-label>
              <input
                matInput
                type="number"
                [formField]="templateForm.participantRegistration.price"
              />
            </mat-form-field>

            <mat-form-field>
              <mat-label>Tax rate</mat-label>
              <mat-select
                [formField]="
                  templateForm.participantRegistration.stripeTaxRateId
                "
              >
                @if (taxRatesQuery.isPending()) {
                  <mat-option disabled>Loading tax rates ...</mat-option>
                } @else if (taxRatesQuery.isSuccess()) {
                  @for (rate of taxRatesQuery.data(); track rate.id) {
                    <mat-option [value]="rate.stripeTaxRateId">
                      {{ rate.displayName || rate.stripeTaxRateId }} —
                      {{ rate.percentage ?? "?" }}%
                    </mat-option>
                  }
                } @else {
                  <mat-option disabled>Failed to load tax rates</mat-option>
                }
              </mat-select>
              <mat-hint>Inclusive tax; shown price is final</mat-hint>
            </mat-form-field>
          }

          <mat-form-field>
            <mat-label>Number of Spots</mat-label>
            <input
              matInput
              type="number"
              [formField]="templateForm.participantRegistration.spots"
            />
            <mat-hint>How many participants can register</mat-hint>
          </mat-form-field>

          <app-role-select
            [formField]="templateForm.participantRegistration.roleIds"
          ></app-role-select>

          <mat-form-field>
            <mat-label>Registration Mode</mat-label>
            <mat-select
              [formField]="templateForm.participantRegistration.registrationMode"
            >
              @for (mode of registrationModes; track mode) {
                <mat-option [value]="mode">
                  {{ mode }}
                </mat-option>
              }
            </mat-select>
            <mat-hint>How registrations are processed</mat-hint>
          </mat-form-field>

          <div class="flex flex-col gap-2">
            <label class="text-on-surface-variant text-sm"
              >Registration Opens Before Event</label
            >
            <app-duration-selector
              [formField]="
                templateForm.participantRegistration.openRegistrationOffset
              "
              hint="How long before the event should registration open"
            ></app-duration-selector>
          </div>

          <div class="flex flex-col gap-2">
            <label class="text-on-surface-variant text-sm"
              >Registration Closes Before Event</label
            >
            <app-duration-selector
              [formField]="
                templateForm.participantRegistration.closeRegistrationOffset
              "
              hint="How long before the event should registration close"
            ></app-duration-selector>
          </div>
        </div>
      </div>
    </div>
  </div>

  <button
    type="submit"
    mat-button
    [disabled]="templateForm().invalid() || isSubmitting()"
  >
    {{ submitLabel() }}
  </button>
</form>
