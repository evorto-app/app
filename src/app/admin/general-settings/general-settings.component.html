<div class="mb-4 flex flex-row items-center gap-2">
  <a routerLink="/admin" mat-icon-button class="lg:hidden! block">
    <fa-duotone-icon [icon]="faArrowLeft"></fa-duotone-icon>
  </a>
  <h1 class="title-large">General settings</h1>
  <div class="grow"></div>
</div>
<div class="grid grid-cols-1 gap-4">
  <div class="bg-surface text-on-surface rounded-2xl p-4">
    <form
      class="grid grid-cols-1"
      [formGroup]="settingsForm"
      (ngSubmit)="saveSettings()"
    >
      <h2 class="title-medium mb-2">Stripe tax rates</h2>
      <p class="text-xs text-gray-600 mb-1">
        Only included (VAT-style) and active tax rates are compatible. You can import compatible tax rates from your Stripe account to use below.
      </p>
      <p class="text-xs text-gray-600 mb-3">
        Manage your tax rates in the Stripe Dashboard: 
        <a
          href="https://dashboard.stripe.com/test/tax-rates"
          target="_blank"
          rel="noopener noreferrer"
          class="underline"
          >Open test tax rates</a
        >.
      </p>

      <div class="mb-2">
        <button mat-stroked-button type="button" (click)="openImportDialog()">
          Import from Stripe
        </button>
      </div>

      <div class="mb-4">
        <h3 class="title-small mb-2">Imported tax rates</h3>
        @if (importedTaxRatesQuery.isPending()) {
          <p>Loading imported tax rates ...</p>
        } @else if (importedTaxRatesQuery.isSuccess()) {
          @if (importedTaxRatesQuery.data().length === 0) {
            <p class="text-xs text-on-surface-variant">No imported tax rates yet.</p>
          } @else {
            <div class="flex flex-col gap-2">
              @for (rate of importedTaxRatesQuery.data(); track rate.id) {
                <div class="flex items-center gap-3">
                  <span>
                    {{ rate.displayName || rate.stripeTaxRateId }}
                    â€” {{ rate.percentage ?? '?' }}%
                  </span>
                  <mat-chip-set>
                    @if (rate.inclusive) {
                      <mat-chip color="primary" selected>included</mat-chip>
                    } @else {
                      <mat-chip color="warn" selected>excluded</mat-chip>
                    }
                    @if (rate.active) {
                      <mat-chip selected>active</mat-chip>
                    } @else {
                      <mat-chip color="warn" selected>archived</mat-chip>
                    }
                  </mat-chip-set>
                </div>
              }
            </div>
          }
        } @else {
          <p>Failed to load imported tax rates.</p>
        }
      </div>

      <div class="mb-4">
        <label class="text-sm font-medium mb-2 block">Default Location</label>
        <p class="text-xs text-gray-600 mb-2">
          Set a default location to improve Google Places search results for your events.
          This location will be used as the center point for location searches.
        </p>
        <app-location-selector-field formControlName="defaultLocation" />
      </div>
      <mat-form-field>
        <mat-label>Site theme</mat-label>
        <mat-select formControlName="theme">
          <mat-option value="evorto">Default theme</mat-option>
          <mat-option value="esn">ESN theme</mat-option>
        </mat-select>
      </mat-form-field>

      <!-- Tax rates are selected per paid registration option. Import them here,
           then choose the appropriate rate when editing registration options. -->

      <h3 class="title-small mb-2 mt-6">Discount providers</h3>
      @if (discountProvidersQuery.isPending()) {
        <p>Loading discount providers ...</p>
      } @else if (discountProvidersQuery.isSuccess()) {
        <div class="mb-4">
          <mat-slide-toggle
            [checked]="esnEnabled()"
            (change)="setEsnEnabled($event.checked)"
          >
            ESN Card discounts
          </mat-slide-toggle>
        </div>
      } @else {
        <p>Failed to load discount providers.</p>
      }
      <button mat-flat-button type="submit" [disabled]="settingsForm.invalid">
        Save
      </button>
    </form>
  </div>
</div>
