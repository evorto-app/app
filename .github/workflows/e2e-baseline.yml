name: E2E Baseline

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    name: Playwright E2E (functional + docs)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      # Ensure Docker build can access the FontAwesome private registry during image build
      FONT_AWESOME_TOKEN: ${{ secrets.FONT_AWESOME_TOKEN }}
      # Make Playwright run in CI mode
      CI: true

    steps:
      - name: Checkout repository
        # Use sparse-checkout false to ensure .env and Docker context are available
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.7"

      - name: Validate required Neon secrets
        run: |
          if [ -z "${{ secrets.NEON_API_KEY }}" ]; then
            echo "::error::Missing required secret: NEON_API_KEY"
            exit 1
          fi
          if [ -z "${{ secrets.NEON_PROJECT_ID }}" ]; then
            echo "::error::Missing required secret: NEON_PROJECT_ID"
            exit 1
          fi

      - name: Configure dynamic runtime ports
        run: |
          eval "$(bun helpers/testing/runtime-env.mjs)"
          {
            echo "APP_HOST_PORT=${APP_HOST_PORT}";
            echo "BASE_URL=${BASE_URL}";
            echo "COMPOSE_PROJECT_NAME=${COMPOSE_PROJECT_NAME}";
            echo "DATABASE_URL=${DATABASE_URL}";
            echo "NEON_DATABASE_NAME=${NEON_DATABASE_NAME}";
            echo "NEON_LOCAL_HOST_PORT=${NEON_LOCAL_HOST_PORT}";
            echo "PLAYWRIGHT_TEST_BASE_URL=${PLAYWRIGHT_TEST_BASE_URL}";
          } >> "$GITHUB_ENV"

      - name: Write CI environment defaults
        run: |
          {
            echo "# Runtime overrides for this CI run";
            echo "BASE_URL=${BASE_URL}";
            echo "PLAYWRIGHT_TEST_BASE_URL=${PLAYWRIGHT_TEST_BASE_URL}";
          } > .env.ci
        env:
          BASE_URL: ${{ env.BASE_URL }}
          PLAYWRIGHT_TEST_BASE_URL: ${{ env.PLAYWRIGHT_TEST_BASE_URL }}

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx --bun playwright install --with-deps

      - name: Create CI .env overrides from secrets
        run: |
          {
          echo "DATABASE_URL=${DATABASE_URL}";
          echo "NEON_LOCAL_PROXY=true";
          echo "NEON_DATABASE_NAME=appdb";
          echo "NEON_API_KEY=${{ secrets.NEON_API_KEY }}";
          echo "NEON_PROJECT_ID=${{ secrets.NEON_PROJECT_ID }}";
          echo "AUTH0_MANAGEMENT_CLIENT_ID=${{ secrets.AUTH0_MANAGEMENT_CLIENT_ID }}";
          echo "AUTH0_MANAGEMENT_CLIENT_SECRET=${{ secrets.AUTH0_MANAGEMENT_CLIENT_SECRET }}";
          echo "CLIENT_ID=${{ secrets.CLIENT_ID }}";
          echo "CLIENT_SECRET=${{ secrets.CLIENT_SECRET }}";
          echo "STRIPE_API_KEY=${{ secrets.STRIPE_API_KEY }}";
          echo "STRIPE_WEBHOOK_SECRET=${{ secrets.STRIPE_WEBHOOK_SECRET }}";
          echo "CLOUDFLARE_R2_S3_KEY=${{ secrets.CLOUDFLARE_R2_S3_KEY }}";
          echo "CLOUDFLARE_R2_S3_KEY_ID=${{ secrets.CLOUDFLARE_R2_S3_KEY_ID }}";
          if [ -n "${{ secrets.CLOUDFLARE_TOKEN }}" ]; then echo "CLOUDFLARE_TOKEN=${{ secrets.CLOUDFLARE_TOKEN }}"; fi
          if [ -n "${{ secrets.CLOUDFLARE_IMAGES_API_TOKEN }}" ]; then echo "CLOUDFLARE_IMAGES_API_TOKEN=${{ secrets.CLOUDFLARE_IMAGES_API_TOKEN }}"; fi
          if [ -n "${{ secrets.PARENT_BRANCH_ID }}" ]; then echo "PARENT_BRANCH_ID=${{ secrets.PARENT_BRANCH_ID }}"; fi
          } > .env
        env:
          DATABASE_URL: ${{ env.DATABASE_URL }}

      - name: Pull Docker images (compose)
        run: docker compose pull

      - name: Build Docker images (compose)
        run: docker compose build --pull

      # Functional tests (keep scope minimal for CI speed). The Playwright webServer will
      # start Docker services via `bun run docker:start-test` from playwright.config.ts.
      - name: Run functional tests (chromium only)
        run: |
          bun run e2e --project=local-chrome

      # Documentation tests: exclude @finance tagged journeys and force the documentation reporter
      # even on CI by overriding reporters via CLI.
      - name: Run documentation tests (exclude @finance)
        env:
          # Allow overriding output directories if desired in future; defaults are fine otherwise.
          DOCS_OUT_DIR: test-results/docs
          DOCS_IMG_OUT_DIR: test-results/docs/images
        run: |
          bunx --bun playwright test --project=docs --grep-invert "@finance" \
            --reporter=github,dot,./tests/support/reporters/documentation-reporter.ts

      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: |
            test-results/**
            playwright-report/**
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload generated docs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-docs
          path: test-results/docs/**
          if-no-files-found: ignore
          retention-days: 14
