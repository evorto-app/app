name: E2E Baseline

on:
  workflow_dispatch:
  push:
    branches: [main, develop]
  pull_request:

concurrency:
  group: e2e-${{ github.ref }}
  cancel-in-progress: true

jobs:
  e2e:
    name: Playwright E2E (functional + docs)
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      FONT_AWESOME_TOKEN: ${{ secrets.FONT_AWESOME_TOKEN }}
      CI: true
      APP_HOST_PORT: 4200
      BASE_URL: http://localhost:4200
      PLAYWRIGHT_TEST_BASE_URL: http://localhost:4200
      COMPOSE_PROJECT_NAME: evorto-ci
      NEON_DATABASE_NAME: appdb
      NEON_LOCAL_HOST_PORT: 55432
      NEON_LOCAL_PROXY: true
      DATABASE_URL: postgresql://neon:npg@localhost:55432/appdb?sslmode=require
      NEON_API_KEY: ${{ secrets.NEON_API_KEY }}
      NEON_PROJECT_ID: ${{ vars.NEON_PROJECT_ID }}
      AUTH0_MANAGEMENT_CLIENT_ID: ${{ secrets.AUTH0_MANAGEMENT_CLIENT_ID }}
      AUTH0_MANAGEMENT_CLIENT_SECRET: ${{ secrets.AUTH0_MANAGEMENT_CLIENT_SECRET }}
      CLIENT_ID: ${{ secrets.CLIENT_ID }}
      CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
      STRIPE_API_KEY: ${{ secrets.STRIPE_API_KEY }}
      STRIPE_WEBHOOK_SECRET: ${{ secrets.STRIPE_WEBHOOK_SECRET }}
      CLOUDFLARE_R2_S3_KEY: ${{ secrets.CLOUDFLARE_R2_S3_KEY }}
      CLOUDFLARE_R2_S3_KEY_ID: ${{ secrets.CLOUDFLARE_R2_S3_KEY_ID }}
      CLOUDFLARE_TOKEN: ${{ secrets.CLOUDFLARE_TOKEN }}
      CLOUDFLARE_IMAGES_API_TOKEN: ${{ secrets.CLOUDFLARE_IMAGES_API_TOKEN }}
      PARENT_BRANCH_ID: ${{ secrets.PARENT_BRANCH_ID }}

    steps:
      - name: Checkout repository
        # Use sparse-checkout false to ensure .env and Docker context are available
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: "1.3.7"

      - name: Validate required configuration
        run: |
          if [ -z "${FONT_AWESOME_TOKEN}" ]; then
            echo "::error::Missing required secret: FONT_AWESOME_TOKEN"
            exit 1
          fi
          if [ -z "${NEON_API_KEY}" ]; then
            echo "::error::Missing required secret: NEON_API_KEY"
            exit 1
          fi
          if [ -z "${NEON_PROJECT_ID}" ]; then
            echo "::error::Missing required repository variable: NEON_PROJECT_ID"
            exit 1
          fi

      - name: Configure FontAwesome npm auth
        run: |
          token="$(printf '%s' "${FONT_AWESOME_TOKEN}" | tr -d '\r\n' | sed -E 's/^[[:space:]]+|[[:space:]]+$//g')"
          if [ "${#token}" -lt 20 ]; then
            echo "::error::FONT_AWESOME_TOKEN is too short after trimming (length=${#token}). Check secret formatting."
            exit 1
          fi
          cp .npmrc "$HOME/.npmrc"
          sed -i '/npm\.fontawesome\.com\/:_authToken/d' "$HOME/.npmrc"
          printf '//npm.fontawesome.com/:_authToken=%s\n' "$token" >> "$HOME/.npmrc"
          status="$(curl -sS -o /dev/null -w '%{http_code}' \
            -H "Authorization: Bearer $token" \
            "https://npm.fontawesome.com/@fortawesome/fontawesome-common-types/-/fontawesome-common-types-7.2.0.tgz")"
          if [ "$status" = "401" ] || [ "$status" = "403" ]; then
            echo "::error::FONT_AWESOME_TOKEN is present but unauthorized for npm.fontawesome.com (HTTP $status). Check token value/scope."
            exit 1
          fi

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Install Playwright browsers
        run: bunx playwright install --with-deps

      - name: Write CI .env file
        run: |
          cat > .env <<EOF
          DATABASE_URL=${DATABASE_URL}
          NEON_LOCAL_PROXY=${NEON_LOCAL_PROXY}
          NEON_DATABASE_NAME=${NEON_DATABASE_NAME}
          NEON_API_KEY=${NEON_API_KEY}
          NEON_PROJECT_ID=${NEON_PROJECT_ID}
          AUTH0_MANAGEMENT_CLIENT_ID=${AUTH0_MANAGEMENT_CLIENT_ID}
          AUTH0_MANAGEMENT_CLIENT_SECRET=${AUTH0_MANAGEMENT_CLIENT_SECRET}
          CLIENT_ID=${CLIENT_ID}
          CLIENT_SECRET=${CLIENT_SECRET}
          STRIPE_API_KEY=${STRIPE_API_KEY}
          STRIPE_WEBHOOK_SECRET=${STRIPE_WEBHOOK_SECRET}
          CLOUDFLARE_R2_S3_KEY=${CLOUDFLARE_R2_S3_KEY}
          CLOUDFLARE_R2_S3_KEY_ID=${CLOUDFLARE_R2_S3_KEY_ID}
          CLOUDFLARE_TOKEN=${CLOUDFLARE_TOKEN}
          CLOUDFLARE_IMAGES_API_TOKEN=${CLOUDFLARE_IMAGES_API_TOKEN}
          PARENT_BRANCH_ID=${PARENT_BRANCH_ID}
          BASE_URL=${BASE_URL}
          PLAYWRIGHT_TEST_BASE_URL=${PLAYWRIGHT_TEST_BASE_URL}
          EOF

      - name: Pull Docker images (compose)
        run: docker compose pull

      - name: Build Docker images (compose)
        run: docker compose build --pull

      # Functional tests (keep scope minimal for CI speed). The Playwright webServer will
      # start Docker services via `bun run docker:start:test` from playwright.config.ts.
      - name: Run functional tests (chromium only)
        run: |
          bun run test:e2e --project=local-chrome

      # Documentation tests: exclude @finance tagged journeys and force the documentation reporter
      # even on CI by overriding reporters via CLI.
      - name: Run documentation tests (exclude @finance)
        env:
          # Allow overriding output directories if desired in future; defaults are fine otherwise.
          DOCS_OUT_DIR: test-results/docs
          DOCS_IMG_OUT_DIR: test-results/docs/images
        run: |
          bunx playwright test --project=docs --grep-invert "@finance" \
            --reporter=github,dot,./tests/support/reporters/documentation-reporter.ts

      - name: Upload Playwright test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-test-results
          path: |
            test-results/**
            playwright-report/**
          if-no-files-found: ignore
          retention-days: 7

      - name: Upload generated docs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-docs
          path: test-results/docs/**
          if-no-files-found: ignore
          retention-days: 14
